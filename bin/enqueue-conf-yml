#!/usr/bin/env perl
use YAML;
$\ = "\n";
exit if !$ARGV[0];

use Data::Dumper;

my $y = YAML::LoadFile($ARGV[0]);

#print YAML::Dump($y->{'Queue'} ) ; exit;

#queue();
#ivr();
#landing();
default();

sub landing {
    for(@{$y->{'Landing'}}){
	print 'exten => ',$_,',1,Answer';
	print 'exten => ',$_,',2,Macro(',$y->{'Name'},'-IVR)';
	print 'exten => ',$_,',3,Hangup';
    }
}

sub queue {
    print '[',$y->{'Name'},'](!)';
    print for(@{$y->{'QueueConf'}});
    print;

    for(@{$y->{'Queue'}}){
	print '[',$y->{'Name'},'-',$_->[0],'](base,',$y->{'Name'},')';
    }
    print;
}

sub ivr {
    print '[macro-',$y->{'Name'},'-ivr]';
    print 'exetn => s,1,Answer';
    print 'exetn => s,2,SET(NAME=',$y->{'Name'},')';

    print 'exetn => s,3,GotoIfTime(',$y->{'Hours'  },',mon-fri,*,*?4:TIME)';
    print 'exetn => s,4,GotoIfTime(',$y->{'HoursWE'},',sat-sun,*,*?5:TIME)';

    print 'exetn => s,5,SET(CHANNEL(musicclass)=',$y->{'MusicHold'},')';
    my $i=5;
    for(@{$y->{'IVR'}}){
	$j = (/^\(/)?'':',';
	print 'exetn => s,', $i++, $j, $_ ;
    }
    print 'exetn => s,',$i++,',GoTo(EXIT)';

    for(@{$y->{'Queue'}}){
	print 'exetn => s,',$i++,'(',$_->[0],'),NoOp()';
	print 'exetn => s,',$i++
	    ,',Set(CALLERID(name)=',$y->{'LongName'},': ',$_->[2],')';
	print 'exetn => s,',$i++
	    ,',Queue(',$y->{'Name'},'-',$_->[0],',,,,',$y->{'TimeOut'},')';
	print 'exetn => s,',$i++,',GoTo(EXIT)';
    }

    for(@{$y->{'Xfer'}}){
	print 'exetn => s,',$i++,'(',$_->[0],'),NoOp()';
	print 'exetn => s,',$i++,',Dial(Local/',$_->[2],')';
	print 'exetn => s,',$i++,',GoTo(EXIT)';
    }

    print 'exetn => s,',$i++,'(EXIT),NoOp()';
    for(@{$y->{'OnExit'}}){
	$j = (/^\(/)?'':',';
	print 'exetn => s,', $i++, $j, $_ ;
    }
    print 'exetn => s,',$i++,',Hangup';

    print 'exetn => s,',$i++,'(TIME),NoOp()';
    for(@{$y->{'Closed'}}){
	$j = (/^\(/)?'':',';
	print 'exetn => s,', $i++, $j, $_ ;
    }
    print 'exetn => s,',$i++,',Hangup';
}

sub default {
    landing();

    print 'exten => ',$y->{'Extn'},'0,1,Answer';
    print 'exten => ',$y->{'Extn'},'0,2,Macro(',$y->{'Name'},'-IVR)';
    print 'exten => ',$y->{'Extn'},'0,3,Hangup';

    ## --- Call + XFer Queue/Extn ---

    for(@{$y->{'Queue'}}){
	print 'exten => ',$y->{'Extn'}.$_->[1],',1,Answer';
	print 'exten => ',$y->{'Extn'}.$_->[1]
	    ,',2,Queue(',$y->{'Name'},'-',$_->[0],')';
	print 'exten => ',$y->{'Extn'}.$_->[1],',3,Hangup';
    }

    for(@{$y->{'Xfer'}}){
	print 'exten => ',$y->{'Extn'}.$_->[1],',1,Answer';
	print 'exten => ',$y->{'Extn'}.$_->[1],',2,Dial(Local/',$_->[2],')';
	print 'exten => ',$y->{'Extn'}.$_->[1],',3,Hangup';
    }

    ## --- Agent LOGIN/LOGOUT ---

    for(@{$y->{'Queue'}}){
	print 'exten => *',$y->{'Extn'}.$_->[1],',1,Answer';
	print 'exten => *',$y->{'Extn'}.$_->[1]
	    ,',2,AddQueueMember(',$y->{'Name'},'-',$_->[0],')';
	print 'exten => *',$y->{'Extn'}.$_->[1],',3,Hangup';

	print 'exten => #',$y->{'Extn'}.$_->[1],',1,Answer';
	print 'exten => #',$y->{'Extn'}.$_->[1]
	    ,',2,RemoveQueueMember(',$y->{'Name'},'-',$_->[0],')';
	print 'exten => #',$y->{'Extn'}.$_->[1],',3,Hangup';
    }

    print;
}
